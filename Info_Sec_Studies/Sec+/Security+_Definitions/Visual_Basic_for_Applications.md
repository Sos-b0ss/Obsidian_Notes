Sources:
https://docs.microsoft.com/en-us/office/vba/api/overview/
https://en.wikipedia.org/wiki/Visual_Basic_for_Applications
\
VBA is the [[Macro]] programming language used in [[Microsoft_Office]], it exist in three different executable forms, each of which can be what is actually executed at run time, depending on the circumstances.
\
These forms are:
-   _Source code_. The original source code of the [[Macro_Module]] is compressed and stored at the end of the module stream. This makes it relatively easy to locate and extract and most free [[DFIR]] tools for macro analysis like [[Oledump]] or [[Olevba]] or even many professional anti-virus tools look only at this form. However, most of the time the source code is completely ignored by Office. In fact, it is possible to remove the source code (and therefore make all these tools think that there are no macros present), yet the macros will still execute without any problems. Most tools will not see any macros in the documents in this archive it but if opened with the corresponding Word version (that matches the document name), it will display a message and will launch `calc.exe`. It is surprising that malware authors are not using this trick more widely.

-   _P-code_. As each [[VBA]] line is entered into the [[VBA]] editor, it is immediately compiled into p-code (a [[Pseudo_Code]] for a stack machine) and stored in a different place in the module stream. The p-code is precisely what is executed most of the time. In fact, even when you open the source of a [[Macro]] module in the [[VBA]] editor, what is displayed is not the decompressed source code but the p-code decompiled into source. Only if the document is opened under a version of Office that uses a different [[VBA]] version from the one that has been used to create the document, the stored compressed source code is re-compiled into p-code and then that p-code is executed. This makes it possible to open a [[VBA]]-containing document on any version of Office that supports [[VBA]] and have the macros inside remain executable, despite the fact that the different versions of [[VBA]] use different (incompatible) p-code instructions.

-   _Execodes_. When the p-code has been executed at least once, a further tokenized form of it is stored elsewhere in the document (in streams, the names of which begin with `__SRP_`, followed by a number). From there it can be executed much faster. However, the format of the [[Execodes]] is extremely complex and is specific for the particular Office version (not [[VBA]] version) in which they have been created. This makes them extremely non-portable. In addition, their presence is not necessary - they can be removed and the macros will run just fine (from the p-code).

Since most of the time it is the p-code that determines what exactly a macro would do (even if neither source code, nor [[Execodes]] are present), it would make sense to have a tool that can display it. This is what prompted us to create this VBA [[P-Code]] disassembler.

---

Visual Basic for Applications is an implementation of Microsoft's Event-Driven Programming language Visual Basic 6.0 built into most desktop Microsoft Office applications. Although based on pre-.NET Visual Basic, which is no longer supported or updated by Microsoft, the [[VBA]] implementation in Office continues to be updated to support new Office features. Despite a poor reputation amongst developers when compared to other high-level languages such as [[Python]] and [[JavaScript]], [[VBA]] is used for professional and end-user development due to its perceived ease-of-use, Office's vast installed userbase, and extensive legacy in business. Visual Basic for Applications enables building user-defined functions, automating processes and accessing [[Windows]] [[API]] and other low-level functionality through dynamic-link libraries ([[DLL]]).
